---
title: "TransborderFreight Data Analysis"
author: "Ebenezer Omari"
output:
  html_notebook: default
  word_document: default
  pdf_document: default
---

This project analyses transportation data from the **Bureau of Transportation Statistics (BTS)** to uncover insights into cross-border freight's efficiency, safety and environmental impacts across modes such as road, rail, air and water.

## CRISP-DM Framework

The analysis followed the CRISP-DM methodology, which includes the following stages:

## 1. Business Understanding

The objectives were defined below, followed by the formulation of analytic questions to guide the analysis process.

### Objectives

-   **Freight Patterns**: Identify trends in freight volume, routing and modes of transport.
-   **Operational Efficiency**: Detect inefficiencies and propose resource optimization strategies.
-   **Environmental Impact**: Assess emissions and fuel usage, recommending sustainability improvements.
-   **Safety Analysis**: Evaluate incidents and suggest safety protocol enhancements.
-   **Economic Effects**: Analyze the impact of trade patterns, policies and global disruptions.
-   **Data-Driven Solutions**: Provide actionable recommendations for improving freight systems.

### Analytic Questions:

a.  What are the top modes of transportation by freight value?

b.  What are the top modes of transportation by freight value in the US states?

c.  Which US state contributes the most to freight weight?

d.  What is the correlation between Freight Value, Shipment Weight and Freight Charges for each year from 2020 to 2024?

e.  How has the total freight value changed over the years from 2020 to 2024?

f.  How do import and export values compare across different states in the US?

g.  What is the variability in shipment weights for exports versus imports?

    -   Do exports or imports show more consistency or is one category more prone to outliers?

## 2. Data Understanding

The data set consisted of 6,517,225 records and 15 variables. Key variables included:

a\. TRDTYPE: Transaction type.

b\. USASTATE, MEXSTATE, CANPROV: Regions involved in freight movement.

c\. VALUE: Value of goods in USD.

d\. SHIPWT: Shipment weight.

e\. FREIGHT_CHARGES: Associated transportation costs.

f\. MONTH

g\. YEAR

## 3. Data Preparation

```{r eval=FALSE, include=FALSE}
# load libraries 
library(janitor)
library(dplyr)
library(ggplot2)
library(scales)
library(reshape2)
```

```{r eval=FALSE, include=FALSE}
# data cleaning

# 2020
# merge the ytd csv files located in the last month of 2020 folder
# the ytd csv consist of data from the month jan to september
spt20dty_1 <- read.csv("00_raw_data/year_2020/September2020/dot1_ytd_0920.csv")
spt20dty_2 <- read.csv("00_raw_data/year_2020/September2020/dot2_ytd_0920.csv")
spt20dty_3 <- read.csv("00_raw_data/year_2020/September2020/dot3_ytd_0920.csv")

# check missing columns
colnames(spt20dty_1)
colnames(spt20dty_2)
colnames(spt20dty_3)

# add missing columns
spt20dty_1 <- spt20dty_1 %>% 
  mutate(COMMODITY2 = NA)

spt20dty_2 <- spt20dty_2 %>% 
  mutate(DEPE = NA)

spt20dty_3 <- spt20dty_3 %>% 
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind the data frame rows to form data_2020
data_2020 <- bind_rows(spt20dty_1, spt20dty_2, spt20dty_3)

# check for duplicates
data_2020 <- data_2020 %>% distinct()




# 2021
# load, merge the ytd csv files located in the last month of 2021 folder
# the ytd csv consist of data from the month jan to december

ytd21_1 <- read.csv("00_raw_data/year_2021/December2021/dot1_ytd_1221.csv")
ytd21_2 <- read.csv("00_raw_data/year_2021/December2021/dot2_ytd_1221.csv")
ytd21_3 <- read.csv("00_raw_data/year_2021/December2021/dot3_ytd_1221.csv")


# check for columns
colnames(ytd21_1)
colnames(ytd21_2)
colnames(ytd21_3)


# add missing columns
ytd21_1 <- ytd21_1 %>% 
  mutate(COMMODITY2 = NA)

ytd21_2 <- ytd21_2 %>% 
  mutate(DEPE = NA)

ytd21_3 <- ytd21_3 %>%
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind rows
data_2021 <- bind_rows(ytd21_1, ytd21_2, ytd21_3)


# 2022
# load, merge the ytd csv files located in the last month of 2022 folder
# the ytd csv consist of data from the month jan to december
ytd22_1 <- read.csv("00_raw_data/year_2022/December2022/dot1_ytd_1222.csv")
ytd22_2 <- read.csv("00_raw_data/year_2022/December2022/dot2_ytd_1222.csv")
ytd22_3 <- read.csv("00_raw_data/year_2022/December2022/dot3_ytd_1222.csv")


# check for column names
colnames(ytd22_1)
colnames(ytd22_2)
colnames(ytd22_3)


# add missing columns
ytd22_1 <- ytd22_1 %>% 
  mutate(COMMODITY2 = NA)

ytd22_2 <- ytd22_2 %>% 
  mutate(DEPE = NA)

ytd22_3 <- ytd22_3 %>%
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind rows
data_2022 <- bind_rows(ytd22_1, ytd22_2, ytd22_3)




# 2023
# merge data in each month for September, October, November, December 2023
# since the data for these months has no ytd csv files
# loading september data
septdata23_1 <- read.csv("./00_raw_data/year_2023/sept2023/dot1_0923.csv")
septdata23_2 <- read.csv("./00_raw_data/year_2023/sept2023/dot2_0923.csv")
septdata23_3 <- read.csv("./00_raw_data/year_2023/sept2023/dot3_0923.csv")

# check column names
colnames(septdata23_1)
colnames(septdata23_2)
colnames(septdata23_3)

# Add missing columns to each data frame
septdata23_1 <- septdata23_1 %>% 
  mutate(COMMODITY2 = NA, DEPE = DEPE, USASTATE = USASTATE)

septdata23_2 <- septdata23_2 %>%  
  mutate(DEPE = NA)

septdata23_3 <- septdata23_3 %>% 
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# Bind data rows together
september_2023 <- bind_rows(septdata23_1, septdata23_2, septdata23_3)


# loading data for october
octdata23_1 <- read.csv("./00_raw_data/year_2023/Oct2023/dot1_1023.csv")
octdata23_2 <- read.csv("./00_raw_data/year_2023/Oct2023/dot2_1023.csv")
octdata23_3 <- read.csv("./00_raw_data/year_2023/Oct2023/dot3_1023.csv")

# check column names
colnames(octdata23_1)
colnames(octdata23_2)
colnames(octdata23_3)


# Add missing columns to each data frame
octdata23_1 <- octdata23_1 %>% 
  mutate(COMMODITY2 = NA)

octdata23_2 <- octdata23_2 %>%  
  mutate(DEPE = NA)

octdata23_3 <- octdata23_3 %>% 
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind data rows together
october_2023 <- bind_rows(octdata23_1, octdata23_2, octdata23_3)


# loading data for november
novdata23_1 <- read.csv("./00_raw_data/year_2023/Nov2023/dot1_1123.csv")
novdata23_2 <- read.csv("./00_raw_data/year_2023/Nov2023/dot2_1123.csv")
novdata23_3 <- read.csv("./00_raw_data/year_2023/Nov2023/dot3_1123.csv")

# check colnames
colnames(novdata23_1)
colnames(novdata23_2)
colnames(novdata23_3)

# Add missing columns to each data frame
novdata23_1 <- novdata23_1 %>% 
  mutate(COMMODITY2 = NA)

novdata23_2 <- novdata23_2 %>%  
  mutate(DEPE = NA)

novdata23_3 <- novdata23_3 %>% 
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind data frames for november
november_2023 <- bind_rows(novdata23_1, novdata23_2, novdata23_3)


# loading data for december
decdata23_1 <- read.csv("./00_raw_data/year_2023/December2023/dot1_1223.csv")
decdata23_2 <- read.csv("./00_raw_data/year_2023/December2023/dot2_1223.csv")
decdata23_3 <- read.csv("./00_raw_data/year_2023/December2023/dot3_1223.csv")

# check colnames
colnames(decdata23_1)
colnames(decdata23_2)
colnames(decdata23_3)


# Add missing columns to each data frame
decdata23_1 <- decdata23_1 %>% 
  mutate(COMMODITY2 = NA)

decdata23_2 <- decdata23_2 %>%  
  mutate(DEPE = NA)

decdata23_3 <- decdata23_3 %>% 
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind data rows for december
december_2023 <- bind_rows(decdata23_1, decdata23_2, decdata23_3)



# merge september to december data set
sept_to_dec_23 <- bind_rows(september_2023, october_2023, november_2023, 
                            december_2023)

# check colnames of date to year from jan to august 2023
jan_to_aug_23_1 <- read.csv("./00_raw_data/year_2023/Aug2023/dot1_ytd_0823.csv")
jan_to_aug_23_2 <- read.csv("00_raw_data/year_2023/Aug2023/dot2_ytd_0823.csv")
jan_to_aug_23_3 <- read.csv("./00_raw_data/year_2023/Aug2023/dot3_ytd_0823.csv")


# check colnames 
colnames(jan_to_aug_23_1)
colnames(jan_to_aug_23_2)
colnames(jan_to_aug_23_3)

# Add missing columns
jan_to_aug_23_1 <- jan_to_aug_23_1 %>% 
  mutate(COMMODITY2 = NA)

jan_to_aug_23_2 <- jan_to_aug_23_2 %>% 
  mutate(DEPE = NA)

jan_to_aug_23_3 <- jan_to_aug_23_3 %>% 
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind rows to form a dataframe
jan_to_aug_23 <- bind_rows(jan_to_aug_23_1, jan_to_aug_23_2, jan_to_aug_23_3)

# bind the two data rows
data_2023 <- bind_rows(jan_to_aug_23, sept_to_dec_23)




# for 2024
# Merging data sets in each month of year 2024
# The data sets in this year's monthly folders has no year to date csv

# For January
jandata24_1 <- read.csv("./00_raw_data/year_2024/Jan2024/dot1_0124.csv")
jandata24_2 <- read.csv("./00_raw_data/year_2024/Jan2024/dot2_0124.csv")
jandata24_3 <- read.csv("./00_raw_data/year_2024/Jan2024/dot3_0124.csv")

# check colnames
colnames(jandata24_1)
colnames(jandata24_2)
colnames(jandata24_3)

# Add missing columns to data set
jandata24_1 <- jandata24_1 %>% 
mutate(COMMODITY2 = NA )

jandata24_2 <- jandata24_2 %>% 
  mutate(DEPE = NA)

jandata24_3 <- jandata24_3 %>% 
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind data rows
january_2024 <- bind_rows(jandata24_1, jandata24_2, jandata24_3)



# For February
febdata24_1 <- read.csv("./00_raw_data/year_2024/Feb2024/dot1_0224.csv")
febdata24_2 <- read.csv("./00_raw_data/year_2024/Feb2024/dot2_0224.csv")
febdata24_3 <- read.csv("./00_raw_data/year_2024/Feb2024/dot3_0224.csv")

# Check colnames 
colnames(febdata24_1)
colnames(febdata24_2)
colnames(febdata24_3)

# Add missing columns to data set
febdata24_1 <- febdata24_1 %>% 
  mutate(COMMODITY2 = NA )

febdata24_2 <- febdata24_2 %>% 
  mutate(DEPE = NA)

febdata24_3 <- febdata24_3 %>% 
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind data rows
february_2024 <- bind_rows(febdata24_1, febdata24_2, febdata24_3)


# for March
mardata24_1 <- read.csv("./00_raw_data/year_2024/March2024/dot1_0324.csv")
mardata24_2 <- read.csv("./00_raw_data/year_2024/March2024/dot2_0324.csv")

# check column names
colnames(mardata24_1)
colnames(mardata24_2)

# Add missing columns
mardata24_1 <- mardata24_1 %>% 
  mutate(COMMODITY2 = NA )

mardata24_2 <- mardata24_2 %>% 
  mutate(DEPE = NA)

# bind rows
march_2024 <- bind_rows(mardata24_1, mardata24_2)


# for April
aprdata24_1 <- read.csv("./00_raw_data/year_2024/April2024/dot1_0424.csv")
aprdata24_2 <- read.csv("./00_raw_data/year_2024/April2024/dot2_0424.csv")
aprdata24_3 <- read.csv("./00_raw_data/year_2024/April2024/dot3_0424.csv")

# check colnames
colnames(aprdata24_1)
colnames(aprdata24_2)
colnames(aprdata24_3)

# add missing columns
aprdata24_1 <- aprdata24_1 %>% 
  mutate(COMMODITY2 = NA)

aprdata24_2 <- aprdata24_2 %>% 
  mutate(DEPE = NA)

aprdata24_3 <- aprdata24_3 %>% 
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind rows 
april_2024 <- bind_rows(aprdata24_1, aprdata24_2, aprdata24_3)


# for may 2024
maydata24_1 <- read.csv("./00_raw_data/year_2024/May2024/dot1_0524.csv")
maydata24_2 <- read.csv("./00_raw_data/year_2024/May2024/dot2_0524.csv")
maydata24_3 <- read.csv("./00_raw_data/year_2024/May2024/dot3_0524.csv")

# check for column names
colnames(maydata24_1)
colnames(maydata24_2)
colnames(maydata24_3)

# add missing columns
maydata24_1 <- maydata24_1 %>% 
  mutate(COMMODITY2 = NA)

maydata24_2 <- maydata24_2 %>% 
  mutate(DEPE = NA)

maydata24_3 <- maydata24_3 %>% 
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind the data frames
may_2024 <- bind_rows(maydata24_1, maydata24_2, maydata24_3)


# for June 2024
junedata24_1 <- read.csv("./00_raw_data/year_2024/June2024/dot1_0624.csv")
junedata24_2 <- read.csv("./00_raw_data/year_2024/June2024/dot2_0624.csv")
junedata24_3 <- read.csv("./00_raw_data/year_2024/June2024/dot3_0624.csv")

# checking columns
colnames(junedata24_1)
colnames(junedata24_2)
colnames(junedata24_3)

# add missing columns
junedata24_1 <- junedata24_1 %>% 
  mutate(COMMODITY2 = NA)

junedata24_2 <- junedata24_2 %>% 
  mutate(DEPE = NA)

junedata24_3 <- junedata24_3 %>% 
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind rows
june_2024 <- bind_rows(junedata24_1, junedata24_2, junedata24_3)


# for july 
judata24_1 <- read.csv("./00_raw_data/year_2024/July2024/dot1_0724.csv")
judata24_2 <- read.csv("./00_raw_data/year_2024/July2024/dot2_0724.csv")
judata24_3 <- read.csv("./00_raw_data/year_2024/July2024/dot3_0724.csv")

# check columns
colnames(judata24_1)
colnames(judata24_2)
colnames(judata24_3)

# add missing columns
judata24_1 <- judata24_1 %>% 
  mutate(COMMODITY2 = NA)

judata24_2 <- judata24_2 %>% 
  mutate(DEPE = NA)

judata24_3 <- judata24_3 %>% 
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind rows
july_2024 <- bind_rows(judata24_1, judata24_2, judata24_3)


# for august
augustdata24_1 <- read.csv("./00_raw_data/year_2024/August2024/dot1_0824.csv")
augustdata24_2 <- read.csv("./00_raw_data/year_2024/August2024/dot2_0824.csv")
augustdata24_3 <- read.csv("./00_raw_data/year_2024/August2024/dot3_0824.csv")

# check for colnames
colnames(augustdata24_1)
colnames(augustdata24_2)
colnames(augustdata24_3)

# add missing columns 
augustdata24_1 <- augustdata24_1 %>% 
  mutate(COMMODITY2 = NA)

augustdata24_2 <- augustdata24_2 %>% 
  mutate(DEPE = NA)

augustdata24_3 <- augustdata24_3 %>% 
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind rows
august_2024 <- bind_rows(augustdata24_1, augustdata24_2, augustdata24_3)


# for september 
septdata24_1 <- read.csv("./00_raw_data/year_2024/september2024/dot1_0924.csv")
septdata24_2 <- read.csv("./00_raw_data/year_2024/september2024/dot2_0924.csv")
septdata24_3 <- read.csv("./00_raw_data/year_2024/september2024/dot3_0924.csv")

# check for columns
colnames(septdata24_1)
colnames(septdata24_2)
colnames(septdata24_3)

# add missing columns
septdata24_1 <- septdata24_1 %>% 
  mutate(COMMODITY2 = NA)

septdata24_2 <- septdata24_2 %>% 
  mutate(DEPE = NA)

septdata24_3 <- septdata24_3 %>% 
  mutate(MEXSTATE = NA, USASTATE = NA, CANPROV = NA)

# bind rows
september_2024 <- bind_rows(septdata24_1, septdata24_2, septdata24_3)

# bind data frames to form 2024 data set
data_2024 <- bind_rows(january_2024, february_2024, march_2024, april_2024,
                       may_2024, june_2024, july_2024, august_2024, september_2024,
                       )

# check columns of data 2020, data 2021, data 2022 & data 2023
colnames(data_2020)
colnames(data_2021)
colnames(data_2022)
colnames(data_2023)
colnames(data_2024)

# combine data frames 
data <- bind_rows(data_2020, data_2021, data_2022, data_2023, data_2024)

# checked for duplicates
# sum(duplicated(data))

# convert TRDTYPE, DISAGMOT, Country, DF, Month, Year
data[c('TRDTYPE', 'DISAGMOT', 'COUNTRY', 'DF', 'MONTH', 'YEAR')] <- lapply(
  data[c('TRDTYPE', 'DISAGMOT', 'COUNTRY', 'DF', 'MONTH', 'YEAR')], as.character
)


# check for NA's or empty cells
colSums(is.na(data) | data == "")

# replace empty cells with NA's
data[data == ""] <- NA

# check if empty cells are replaced
colnames(data)[apply(data, 2, anyNA)]

# View structure of the data
str(data)

# Filling the  NA values of each column
# Check unique values of each column
unique(data$USASTATE)
unique(data$DEPE)
unique(data$MEXSTATE)
unique(data$CANPROV)
unique(data$DF)


# fill of the USASTATE NA's based on the DEPE codes
# create a vector
depe_mapping <- c(
  "01XX" = "ME", "0101" = "ME", "0102" = "ME", "0103" = "ME", "0104" = "ME", "0105" = "ME",
  "0106" = "ME", "0107" = "ME", "0108" = "ME", "0109" = "ME", "0110" = "ME", "0111" = "ME",
  "0112" = "ME", "0115" = "ME", "0118" = "ME", "0121" = "ME", "0127" = "ME", "0131" = "NH",
  "0132" = "ME", "0182" = "NH", "0152" = "ME", "0181" = "ME",
  "02XX" = "VT", "0201" = "VT", "0203" = "VT", "0206" = "VT", "0207" = "VT",
  "0209" = "VT", "0211" = "VT", "0212" = "VT",
  "04XX" = "MA", "0401" = "MA", "0402" = "MA", "0403" = "MA", "0404" = "MA", "0405" = "MA",
  "0406" = "MA", "0407" = "MA", "0408" = "MA", "0409" = "MA", "0410" = "CT", "0411" = "CT",
  "0412" = "CT", "0413" = "MA", "0417" = "MA",
  "05XX" = "RI", "0501" = "RI", "0502" = "RI", "0503" = "RI",
  "07XX" = "NY", "0701" = "NY", "0704" = "NY", "0706" = "NY", "0708" = "NY",
  "0712" = "NY", "0714" = "NY", "0715" = "NY",
  "09XX" = "NY", "0901" = "NY", "0903" = "NY", "0904" = "NY", "0905" = "NY",
  "0906" = "NY", "0971" = "NY", "0972" = "NY", "0981" = "NY",
  "10XX" = "NY", "1001" = "NY", "1002" = "NY", "1003" = "NJ", "1012" = "NY",
  "11XX" = "PA", "1101" = "PA", "1102" = "PA", "1103" = "DE", "1104" = "PA",
  "1105" = "NJ", "1106" = "PA", "1107" = "NJ", "1109" = "PA", "1113" = "NJ",
  "1119" = "PA", "1181" = "PA", "1182" = "NJ", "1183" = "NJ", "1195" = "PA",
  "13XX" = "MD", "1301" = "MD", "1302" = "MD", "1303" = "MD", "1304" = "MD", "1305" = "MD",
  "14XX" = "VA", "1401" = "VA", "1402" = "VA", "1404" = "VA", "1408" = "VA",
  "1409" = "VA", "1410" = "VA", "1412" = "VA",
  "15XX" = "NC", "1501" = "NC", "1502" = "NC", "1503" = "NC", "1506" = "NC",
  "1511" = "NC", "1512" = "NC",
  "16XX" = "SC", "1601" = "SC", "1602" = "SC", "1603" = "SC", "1604" = "SC", "1681" = "SC",
  "17XX" = "GA", "1701" = "GA", "1703" = "GA", "1704" = "GA",
  "18XX" = "GA", "1801" = "FL", "1803" = "FL", "1805" = "FL", "1807" = "FL", "1808" = "FL",
  "1809" = "FL", "1814" = "FL", "1816" = "FL", "1818" = "FL", "1819" = "FL",
  "1821" = "FL", "1822" = "FL", "1883" = "FL", "1884" = "FL", "1885" = "FL",
  "1886" = "FL", "1887" = "FL",
  "19XX" = "AL", "1901" = "AL", "1903" = "AS", "1904" = "LA", "1910" = "LA",
  "2006" = "TN", "2007" = "TN",
  "23XX" = "TX", "2301" = "TX", "2302" = "TX", "2303" = "TX", "2304" = "TX",
  "2305" = "TX", "2307" = "TX", "2310" = "TX",
  "24XX" = "TX", "2402" = "TX", "2403" = "TX", "2404" = "TX", "2406" = "NM",
  "2407" = "NM", "2408" = "NM", "2481" = "NM",
  "25XX" = "CA", "2501" = "CA", "2502" = "CA", "2503" = "CA", "2504" = "CA",
  "2505" = "CA", "2506" = "CA", "2507" = "CA",
  "26XX" = "AZ", "2601" = "AZ", "2602" = "AZ", "2603" = "AZ", "2604" = "AZ",
  "2605" = "AZ", "2606" = "AZ", "2608" = "AZ", "2609" = "AZ",
  "27XX" = "CA", "2704" = "CA", "2720" = "CA",
  "30XX" = "WA", "31XX" = "WA", "32XX" = "OR", "33XX" = "MT", "34XX" = "ND",
  "35XX" = "MN", "36XX" = "WI", "37XX" = "MI", "38XX" = "MI", "39XX" = "OH",
  "41XX" = "IL", "45XX" = "KY", "49XX" = "LA", "51XX" = "NM", "52XX" = "TX",
  "53XX" = "WA", "54XX" = "OR", "55XX" = "TX", "59XX" = "CA",
  "60XX" = "HI", "80XX" = "AK"
)

# Replace NA values in USASTATE based on DEPE mapping
data$USASTATE[is.na(data$USASTATE)] <- depe_mapping[data$DEPE[is.na(data$USASTATE)]]





```

```{r}
# Fill the NA's in the DEPE column
# Define a function to calculate the mode (most frequent value)
getmode <- function(v) {
  uniq_v_depe <- unique(na.omit(v))
  uniq_v_depe[which.max(tabulate(match(v, uniq_v_depe)))]
}

# Calculate the most frequent DEPE for each USASTATE
mode_depe_by_state <- data %>%
  group_by(USASTATE) %>%
  summarise(mode_DEPE = getmode(DEPE), .groups = "drop")

# Fill in missing DEPE values based on the mode for the respective USASTATE
data <- data %>%
  left_join(mode_depe_by_state, by = "USASTATE") %>%
  mutate(DEPE = if_else(is.na(DEPE), mode_DEPE, DEPE)) %>%
  select(-mode_DEPE)
```

```{r eval=FALSE, include=FALSE}
# Check if all NA values are replaced
sum(is.na(data$USASTATE))

# fill the remaining NA's in the USASTATE, DF, COMMODITY2
# Columns to fill
columns_to_fill <- c("USASTATE", "DF", "COMMODITY2")

# Fill missing values with the most frequent value
data <- data %>%
  mutate(across(all_of(columns_to_fill), ~ replace(., is.na(.), names(which.max(table(na.omit(.)))))))


# Mapping the values in 'CONTCODE' column
data <- data %>%
  mutate(CONTCODE = recode(CONTCODE, "X" = "Containerized", "0" = "Non-Containerized"))



# Check the result
unique(data$CONTCODE)


```

```{r}
# Condition Mismatch:
# The code only fills missing values for rows that meet the specific conditions: For MEXSTATE, it fills NA's only when both MEXSTATE and CANPROV are missing and COUNTRY equals 2010. For CANPROV, it fills NA's only when both are missing and COUNTRY equals 1220. Check whether the remaining NA's have different COUNTRY values or if only one of the two columns is missing. If so, they won’t be matched by your masks.

# Define a function to calculate the mode (most frequent value)
getmode <- function(v) {
  uniqv <- unique(na.omit(v))
  uniqv[which.max(tabulate(match(v, uniqv)))]
}

# Create a mask for rows where MEXSTATE and CANPROV are NA and COUNTRY equals 2010
mex_mask <- is.na(data$MEXSTATE) & is.na(data$CANPROV) & (data$COUNTRY == 2010)

# Fill missing MEXSTATE values (for those rows) with the mode of the MEXSTATE column
data$MEXSTATE[mex_mask] <- getmode(data$MEXSTATE)

# Create a mask for rows where MEXSTATE and CANPROV are NA and COUNTRY equals 1220
can_mask <- is.na(data$MEXSTATE) & is.na(data$CANPROV) & (data$COUNTRY == 1220)

# Fill missing CANPROV values (for those rows) with the mode of the CANPROV column
data$CANPROV[can_mask] <- getmode(data$CANPROV)
```

## 4. Analysis and Visualization

```{r echo=FALSE}
# summary statistics aggregated across the entire data set

options(scipen = 999) # set to avoid scientific notation 

summary_statistics <- data %>%
  summarise(
    Total_Value = sum(VALUE),
    Total_ShipWt = sum(SHIPWT),
    Total_Freight_Charges = sum(FREIGHT_CHARGES),
    Avg_Value = mean(VALUE),
    Avg_ShipWt = mean(SHIPWT),
    Avg_Freight_Charges = mean(FREIGHT_CHARGES, na.rm = T)
  )

summary_statistics
format(summary_statistics, scientific = F, big.mark = ",")
print(summary_statistics)
```

The data set covered multiple years and regions, with data on road, rail, air sand water transport modes. Summary statistics across the data set (2020 – 2024) revealed:

Total Value: The cumulative value of all freight transactions across the data set is 19.20 trillion USD. This metric highlights the enormous scale of trans-border freight in terms of monetary value.

Total Shipment Weight: The total shipping weight of goods transported is 7.82 trillion kg. This gave an idea of the physical scale of goods being moved.

Total Freight Charges: The total freight charges across all transactions amount to 251.02 billion USD, showing the financial cost of transportation.

```{r eval=FALSE, include=FALSE}
# Grouping data by YEAR and calculating yearly statistics
yearly_statistics <- data %>% 
  group_by(YEAR) %>%
  summarise(
    #Total_Value = sum(VALUE),
    #Total_ShipWt = sum(SHIPWT),
    #Total_Freight_Charges = sum(FREIGHT_CHARGES),
    Avg_Value = mean(VALUE),
    Avg_ShipWt = mean(SHIPWT),
    Avg_Freight_Charges = mean(FREIGHT_CHARGES)
  ) %>%
  # round the numbers to  3 decimals
  mutate(
    #Total_Value = round(Total_Value /1e9, 3), # convert to billions and round
    #Total_ShipWt = round(Total_ShipWt /1e9, 3), # convert to billions and round
    #Total_Freight_Charges = round(Total_Freight_Charges /1e6), # convert to millions and round
    Avg_Value = round(Avg_Value, 3),
    Avg_ShipWt = round(Avg_ShipWt, 3),
    Avg_Freight_Charges = round(Avg_Freight_Charges, 3)
  ) %>% 
  # Add units for clarity
  mutate(
    #Total_Value = paste(Total_Value, "B", sep = ""),
    #Total_ShipWt = paste(Total_ShipWt, "B", sep = ""),
    #Total_Freight_Charges = paste(Total_Freight_Charges, "M", sep = ""),
    Avg_Value = paste(Avg_Value, "M", sep = ""),
    Avg_ShipWt = paste(Avg_ShipWt, "kg", sep = ""),
    Avg_Freight_Charges = paste(Avg_Freight_Charges, "M", sep = "")
  )

# print yearly statistics
print(yearly_statistics)
```

The data set covered multiple years and regions, with data on road, rail, air sand water transport modes.

In 2020, the average value of the goods was about 2.27 million dollars with an average shipping weight of 1.23 million kg. The average freight charges for shipping were 32.76 million.

In 2021, the average value of the goods increased to 2.76 million dollars, while the average shipping weight was almost the same at 1.22 million kg. Freight charges also rose to 36.55 million.

In 2022, the average value reached its peak at 3.20 million dollars, but the shipping weight slightly decreased to 1.21 million kg. Freight charges continued to increase to 42.52 million.

In 2023, the average value dropped slightly to 3.18 million, with a further decrease in shipping weight to 1.20 million kg. The average freight charges went down slightly to 40.98 million.

Key Findings from the analytic questions:

**What are the top modes of transportation by freight volume and value?**

```{r echo=FALSE}
# Data visualisation based on transportation mode (DISAGMOT)
mode_description <- c(
  "1"  = "Vessel",
  "3" = "Air",
  "4" = "Mail (U.S. Post Service)",
  "5" = "Truck",
  "6" = "Rail",
  "7" = "Pipeline",
  "8" = "Other",
  "9" = "Foreign Trade Zones (FTZs)"
)

# plotting the freight value by mode across the years
transportation_mode <- ggplot(data, aes(
  x = YEAR, y = VALUE / 1e6,
  fill = factor(DISAGMOT)
)) + geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Top Modes of Transportation by Freight Value",
    x = "Year",
    y = "Value (in millions)"
  ) + 
  theme_minimal() +
  scale_fill_manual(
    values = RColorBrewer::brewer.pal(8, "Set2"),  # Choosing a color palette with enough colors
    labels = mode_description,                    # Custom labels for transportation modes
    name = "Transportation Mode"
  )

# print transportation mode
transportation_mode
```

The bar chart above shows the distribution of freight value (in millions of USD) by transportation mode for each year. Each mode is represented by a distinct colour:

Key Observations:

Trucks and pipeline dominates the freight value across most years, indicating their importance in domestic and regional transportation.

Air transportation, while less significant in terms of value, consistently contributes a notable portion of the freight value, highlighting its role in high-value shipments.

Pipelines and vessels also contribute significantly, particularly for specific years where bulk commodities like oil or goods with high shipping requirements were involved.

**What are the top modes of transportation by freight value in the US states?**

```{r echo=FALSE}
library(RColorBrewer)
# Filter data for the desired years
yearly_data <- data %>% 
  filter(YEAR %in% c(2020, 2021, 2022, 2023, 2024))
  
# Summarize freight value by YEAR, USASTATE, and DISAGMOT
us_trade_mode <- yearly_data %>%
  group_by(YEAR, USASTATE, DISAGMOT) %>%
  summarise(Total_Value = sum(VALUE), .groups = "drop")

# Get overall total freight value by state
us_state_totals <- yearly_data %>%
  group_by(USASTATE) %>%
  summarise(Overall_Value = sum(VALUE), .groups = "drop") %>%
  arrange(desc(Overall_Value))

# Select the top 10 states based on Overall_Value
top_states <- us_state_totals %>%
  slice_max(Overall_Value, n = 10) %>%
  pull(USASTATE)

# Filter the mode-level data to include only these top states
us_trade_mode_top10 <- us_trade_mode %>%
  filter(USASTATE %in% top_states)

# Aggregate the filtered data across years for each state and mode
us_trade_mode_top10_agg <- us_trade_mode_top10 %>%
  group_by(USASTATE, DISAGMOT) %>%
  summarise(Total_Value = sum(Total_Value), .groups = "drop")

# Create a mapping for DISAGMOT codes to descriptive names
mode_description <- c(
  "1"  = "Vessel",
  "3"  = "Air",
  "4"  = "Mail (U.S. Post Service)",
  "5"  = "Truck",
  "6"  = "Rail",
  "7"  = "Pipeline",
  "8"  = "Other",
  "9"  = "Foreign Trade Zones (FTZs)"
)

# Plot the data with freight values in trillions of dollars
ggplot(us_trade_mode_top10_agg, aes(x = USASTATE, y = Total_Value / 1e12, fill = factor(DISAGMOT))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_y_continuous(labels = label_number(scale = 1, suffix = "T")) +  # Display values in trillions
  scale_fill_manual(
    values = brewer.pal(8, "Set2"),
    labels = mode_description,
    name = "Transportation Mode"
  ) +
  labs(
    title = "Top Modes of Transportation by Freight Value (Top 10 US States)",
    x = "US State",
    y = "Freight Value (Trillions of Dollars)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Analysis:

The bar chart above illustrates the distribution of freight value (in trillions of USD) by transportation mode over the past four years across the top 10 US states. Each transportation mode is color-coded, allowing for easy differentiation.

Notably, truck transportation overwhelmingly dominates the freight value. Texas is particularly prominent, with truck freight value exceeding 4.5 trillion USD, far surpassing the contributions of other states. California also shows significant activity, recording over 1 trillion USD in truck freight value. In contrast, other modes such as rail, air and pipeline consistently contribute less, with freight values remaining below 1 trillion USD across these states.

These observations indicate that truck transport is the critical driver of freight value in the US, especially in key states like Texas and California, while the contribution of other modes is relatively modest.

**Which US state contributes the most to ship weight**

```{r echo=FALSE}
# List of years to process
years <- c(2020, 2021, 2022, 2023, 2024)

for(year in years) {
  # filter data for the current year
  yearly_data <- data %>%  filter(YEAR == year)
  
  # summarize the total freight (SHIPWT) by state 
  state_freight_summary <- yearly_data %>% 
    group_by(USASTATE) %>% 
    summarise(Total_ShipWt = sum(SHIPWT)) %>% 
    arrange(desc(Total_ShipWt)) # sort by total freight

 # Limit to top 10 states for better readability
  state_freight_summary <- head(state_freight_summary, 10) %>% 
  filter(!is.na(USASTATE) & USASTATE != "")

# Create a bar plot of the freight weight by US state for the current year
  plot <- ggplot(state_freight_summary, aes(x = reorder(USASTATE, Total_ShipWt), y = Total_ShipWt / 1e3)) +
    geom_col(fill = "steelblue") +   # Bar color
    coord_flip() +                   # Flip the bars horizontally
    labs(
      title = paste("Total Ship Weight by US State (", year, ")", sep = ""),
      x = "State",
      y = "Weight (in thousands of kilograms)"
    ) +
    theme_minimal() +                # Simple clean theme
    theme(
      axis.text.x = element_text(size = 10),  # Adjust text size for better legibility
      axis.text.y = element_text(size = 10),  # Adjust y-axis text size
      plot.margin = margin(10, 50, 10, 10)    # Increase the space around the plot to avoid cutting off labels
    )
  
  # Print the plot for the current year
  print(plot)
}
```

Analysis:

The states with the highest freight weight include Texas followed by Illinois and Ohio. Texas led by a significant margin throughout the years from 2020 to 2024, reflecting its central role, in freight logistics, possibly due to its major ports and highways.

**What is the correlation between Freight Value, Shipment Weight and Freight Charges for each year from 2020 to 2024?**

```{r echo=FALSE}
# Correlation Between Value, Weight, and Freight Charges
# List of years to process
years <- c(2020, 2021, 2022, 2023, 2024)
# Loop through each year to calculate and print the correlation matrix
for (year in years) {
  # Filter the data for the current year
  yearly_data <- data %>% filter(YEAR == as.character(year))
  
  # Calculate the correlation matrix for VALUE, SHIPWT, and FREIGHT_CHARGES
  correlation_matrix <- yearly_data %>%
    select(VALUE, SHIPWT, FREIGHT_CHARGES) %>%
    cor(use = "complete.obs") # consider rows where there are no missing values(NA)
  
  # Print the correlation matrix for the current year
  print(paste("Correlation Matrix for Year:", year))
  print(correlation_matrix)
}

# Initialise an empty data frame for storing correlation data
correlation_data <- data.frame()

# Loop through each year to calculate correlations
for (year in years) {
  yearly_data <- data %>% filter(YEAR == as.character(year))
  corr_matrix <- yearly_data %>%
    select(VALUE, SHIPWT, FREIGHT_CHARGES) %>%
    cor(use = "complete.obs")
  
  # Convert the correlation matrix to a long format
  melted_corr <- melt(corr_matrix)
  melted_corr$Year <- year
  
  # Append to the correlation_data data frame
  correlation_data <- rbind(correlation_data, melted_corr)
}

# Round the correlation values to 2 decimal places
correlation_data$value <- round(correlation_data$value, 2)

# Plot heatmap with labels
ggplot(correlation_data, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  geom_text(aes(label = value), colour = "black", size = 3) +  # to add text labels
  facet_wrap(~ Year) +
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red",
    midpoint = 0, limits = c(-1, 1),
    name = "Correlation"
  ) +
  labs(
    title = "Correlation Heatmaps (2020–2024) with Values",
    x = "Variable", y = "Variable"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 12),  #facet title size
    axis.text.x = element_text(angle = 45, hjust = 1)  # to Rotate x-axis labels
  )


```

Analysis from 2020:

-   Freight Value vs. Shipment Weight (0.40): A moderate positive correlation indicates that higher shipment weight is associated with an increase in freight value, though the relationship is not strong.

-   Freight Value vs. Freight Charges (0.45): A moderate positive correlation suggests that higher freight value tend to be associated with higher freight charges.

-   Shipment Weight vs. Freight Charges (0.86): A strong positive correlation implies that heavier shipments tend to incur higher freight charges.

Analysis from 2021:

-   Freight Value vs. Shipment Weight (0.54): A moderate positive correlation, slightly stronger than in 2020, shows an increasing association between shipment weight and freight value.

-   Freight Value vs. Freight Charges (0.57): A moderate positive correlation, also stronger than in 2020, highlights a growing relationship between freight value and freight charges.

-   Shipment Weight vs. Freight Charges (0.87): The strong positive correlation remains consistent, indicating a continued link between shipment weight and charges.

Analysis from 2022:

-   Freight Value vs. Shipment Weight (0.64): A stronger positive correlation reflects a significant relationship between the value of goods and their shipment weight this year.

-   Freight Value vs. Freight Charges (0.64): The correlation strengthens, showing a notable association between freight value and charges.

-   Shipment Weight vs. Freight Charges (0.83): The strong positive correlation decreases slightly but remains substantial.

Analysis for 2023:

-   Freight Value vs. Shipment Weight (0.56): A moderate positive correlation, lower than 2022, indicates the relationship between value and shipment weight weakened slightly.

-   Freight Value vs. Freight Charges (0.59): A consistent moderate positive correlation reflects a stable association between freight value and charges.

-   Shipment Weight vs. Freight Charges (0.89): The strong positive correlation indicates the relationship remains solid between shipment weight and charges

Analysis for 2024:

-   Freight Value vs. Shipment Weight (0.53): A moderate positive correlation, slightly lower than in 2023, suggests a declining association.

-   Freight Value vs. Freight Charges (0.57): The consistent correlation indicates that freight value and charges remain moderately linked.

-   Shipment Weight vs. Freight Charges (0.91): A very strong positive correlation indicates an almost linear relationship, suggesting that heavier shipments are nearly directly proportional to higher freight charges.

Overall Interpretation:

1.  Shipment Weight and Freight Charges: Across all years, there is a consistently strong positive correlation (above 0.89), with the strongest in 2024 (0.91). This indicates that shipment weight is a critical determinant of freight charges.

2.  Freight Value and Shipment Weight: The correlation is generally moderate, ranging from 0.40 in 2020 to a peak of 0.64 in 2022 and then slightly declining afterward. This suggests that heavier shipments tend to have higher values, but the relationship is not as strong or consistent as with freight charges.

3.  Freight Value and Freight Charges: The correlation is moderate across all years, ranging from 0.45 to 0.64, indicating that while higher-value shipments often result in higher charges, other factors also contribute.

Key Insights:

-   Shipment weight is the dominant factor influencing freight charges.

-   While freight value contributes to determining charges, its impact is moderate compared to shipment weight.

-   The year 2022 shows the strongest correlations across all variables, possibly indicating unusual or specific market conditions.

**How has the total freight value changed over the years from 2020 to 2024?**

```{r echo=FALSE}
# Yearly trend Analysis
# Freight Value by Year
yearly_trends <- data %>%
  group_by(YEAR) %>%
  summarise(Total_Value = sum(VALUE))

ggplot(yearly_trends, aes(x = as.factor(YEAR), y = Total_Value / 1e6)) +
  geom_line(group = 1, color = "blue") +
  labs(
    title = "Yearly Freight Value Trends",
    x = "Year",
    y = "Value (in millions)"
  ) +
  theme_minimal()
```

Analysis of Freight Value Trends (2020-2024):

From the data:

-   The freight value increased steadily from 2020 to 2022.

-   The notable jump in 2021 and 2022 could reflect a post-2020 recovery in global trade, potentially spurred by the easing of pandemic restrictions,

-   The freight value remained very similar between 2022 and 2023, indicating that the growth peaked around 2022–2023, with 2023 having the highest freight value.

-   The decline in 2024 suggests that either the volume or value of shipments decreased. This drop might signal a market correction, changes in trade patterns or other external factors affecting freight services.

-   This suggests consistent growth in freight activities or higher-value shipments over the years.

Insights:

The significant year-on-year increase from 2020 to 2023 could indicate:

Increased global trade and an expansion in freight services, especially after 2020 (potentially post-pandemic recovery)

The decline in 2024 is noteworthy and may warrant further investigation to understand the underlying reasons such as economic shifts, changes in trade policy or other market dynamics.

**How do import and export values compare across different states in the US?**

```{r echo=FALSE}
options(scipen = 999) # Avoid scientific notation

# Prepare the data for the US states
us_trade <- data %>% 
  group_by(TRDTYPE, USASTATE) %>% 
  summarise(Total_Value = sum(VALUE), .groups = "drop") %>% 
  mutate(Country = "USA") 

# Select the top 10 states based on Total_Value
us_trade_top10 <- us_trade %>% 
  slice_max(Total_Value, n = 10)

# Visualise the trade values of import and export amongst the top 10 USA states
ggplot(us_trade_top10, aes(x = USASTATE, y = Total_Value, fill = factor(TRDTYPE, labels = c("Export", "Import")))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_y_continuous(labels = label_number(scale = 1e-12, suffix = "T")) +  # Convert to trillions
  labs (
    title = "Trade Values for Top 10 US States Over The Past Four Years",
    x = "US State",
    y = "Total Trade Value (Trillions of Dollars)",
    fill = "Trade Type"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

### **Trade Value Analysis**

Based on the chart, the total trade value (combining both imports and exports) for these states ranges from 0 to approximately 2.5 trillion dollars, underscoring that the trade activities in these regions are significant on a global scale.

In particular, Texas stands out with a high import value while also leading in exports, positioning it as a major hub for both inbound and outbound goods. In contrast, California's trade profile is characterized by a substantial import value that far exceeds its export figures.

Moreover, states like Miami, Illinois and Ohio exhibit trade activity that is almost exclusively import-oriented, with their total trade values remaining below 1 trillion dollars. These insights highlight the diverse trade dynamics across US states, providing a valuable perspective for policy makers and businesses aiming to enhance global trade competitiveness.

Given the range of trade values from 0 to 2.5 trillion dollars, it's clear that there is a substantial variation in trade activities among these states. Factors such as geographic location, industry focus and infrastructure play significant roles in determining each state's trade value.

**What is the variability in shipment weights for exports versus imports?**

Do exports or imports show more consistency, or is one category more prone to outliers?

```{r echo=FALSE, warning=FALSE}
ggplot(data, aes(x = factor(TRDTYPE, labels = c("Export", "Import")), y = SHIPWT)) +
  geom_boxplot(fill = "lightgreen") +
  scale_y_log10() +  # Use log scale if weights vary widely
  labs(
    title = "Shipment Weight Distribution by Trade Type",
    x = "Trade Type",
    y = "Shipment Weight"
  ) +
  theme_minimal()
```

The box plot comparing shipment weight for exports and imports reveals several key insights. First, the median shipment weight for imports is higher than that for exports, indicating that, on average, import shipments tend to be heavier. The export distribution, shown by a smaller box, suggests less variability and more consistency in shipment weight, whereas the import distribution is more spread out, pointing to greater variability among import shipments.

Both trade types exhibit outliers, individual points that fall outside the whiskers with exports displaying a greater number of outliers than imports. Moreover, the distribution of import shipment weights is positively skewed, meaning the data has a longer tail towards the higher weights, while the export distribution appears more symmetric.

## **Confirmatory Data Analysis**

H₀ (null): Freight Value has no effect on trade type

H₁ (alternative): Freight Value affects Trade Type

Dependent variable (y): Trade type

Independent variable (x): Freight value

Significant level (a): 5% or 0.05

```{r echo=FALSE}
# Ensure TRDTYPE is a factor with appropriate labels
data$TRDTYPE <- factor(data$TRDTYPE, levels = c("1", "2"))

# Fit a logistic regression model
log_model <- glm(TRDTYPE ~ VALUE, data = data, family = binomial)

#summarize the model
summary(log_model)
```

**Analysis:**

**Coefficients**

Intercept:

-   Estimate: -0.069606

VALUE:

-   Estimate: 0.00000000414899 (4.15e-09)

**Statistical significance:**

Both coefficients are statistically significant (p values are essentially 0, i.e., \<2e-)

**Interpretation:**

Significance of VALUE: The freight value is a statistically significant predictor of trade type. Despite the very small coefficient (due to the scale of VALUE), the extremely low p-value indicates that the relationship is highly unlikely to be due to random chance.

Effect Size: Because VALUE is measured in dollars, its coefficient (approximately 4.15e-09 per dollar) might seem negligible at first glance. However, if changes are considered on a larger scale (e.g., per million dollars), the effect becomes more interpretable. For example, a one million dollar increase in freight value would increase the log-odds of the trade type by about 0.00415.

**Conclusion:**

-   Null Hypothesis (H₀): Freight value has no effect on trade type.

-   Alternative Hypothesis (H₁): Freight value affects trade type.

Since the coefficient of the VALUE is highly statistically significant, p value \< a, the null hypothesis is rejected, which concludes that Freight value affects trade type.
